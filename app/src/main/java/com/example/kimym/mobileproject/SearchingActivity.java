package com.example.kimym.mobileproject;import android.content.Context;import android.content.Intent;import android.content.pm.PackageManager;import android.location.Address;import android.location.Geocoder;import android.location.Location;import android.location.LocationListener;import android.location.LocationManager;import android.net.Uri;import android.os.Bundle;import android.support.annotation.NonNull;import android.support.v4.app.ActivityCompat;import android.support.v4.content.ContextCompat;import android.support.v7.app.AppCompatActivity;import android.util.Log;import android.widget.TextView;import android.widget.Toast;import com.google.firebase.database.DataSnapshot;import com.google.firebase.database.DatabaseError;import com.google.firebase.database.DatabaseReference;import com.google.firebase.database.FirebaseDatabase;import com.google.firebase.database.ValueEventListener;import java.io.IOException;import java.util.ArrayList;import java.util.List;import java.util.Locale;public class SearchingActivity extends AppCompatActivity {    static int REQ_PERMISSION_MAP = 1000;    Intent intent;    boolean Check_direct;    DatabaseReference table;    double myLat;    double myLng;    String myLocation = null;    String fastLocation = null;    Geocoder geocoder;    double minDist;    ToiletData minToilet;    boolean flag =false;    LocationManager locationmanager;    TextView searchText;    public static ArrayList<ToiletData> mapResults;    private static String[] permission_map = {            android.Manifest.permission.ACCESS_FINE_LOCATION,            android.Manifest.permission.ACCESS_COARSE_LOCATION    };    private boolean checkPermission(String[] requestPermission) {        boolean[] requestResult = new boolean[requestPermission.length];        for (int i = 0; i < requestResult.length; i++) {            requestResult[i] = (ContextCompat.checkSelfPermission(this, requestPermission[i]) == PackageManager.PERMISSION_GRANTED);            if (!requestResult[i]) {                return false;            }        }        return true;    }    private void askPermission(String[] requestPermission, int requestCode) {        ActivityCompat.requestPermissions(                this,                requestPermission,                requestCode        );    }    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_searching);        intent = getIntent();        Check_direct = intent.getBooleanExtra("DIRECT", false);        FirebaseDatabase database = FirebaseDatabase. getInstance ();        table = database.getReference("ToiletDB");        myLng = 0; myLat = 0;        geocoder = new Geocoder(this, Locale.KOREA);        intent = getIntent();        Check_direct = intent.getBooleanExtra("DIRECT", false);        minToilet = new ToiletData();        searchText = (TextView)findViewById(R.id.searchtext);        locationmanager = (LocationManager) getSystemService(Context.LOCATION_SERVICE);        if (checkPermission(permission_map)) {            locationmanager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 100, 1, mLocationListener);            locationmanager.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, 100, 1, mLocationListener);        }        else{            askPermission(permission_map,REQ_PERMISSION_MAP);        }    }    @Override    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {        super.onRequestPermissionsResult(requestCode, permissions, grantResults);        if(requestCode == REQ_PERMISSION_MAP) {            if (grantResults.length > 0) {                if (checkPermission(permission_map)) {                    locationmanager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 100, 1, mLocationListener);                    locationmanager.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, 100, 1, mLocationListener);                }                else{                    askPermission(permission_map, REQ_PERMISSION_MAP);                }            }        }    }    private final LocationListener mLocationListener = new LocationListener() {        @Override        public void onLocationChanged(Location location) {            if(flag == false){                Toast.makeText(SearchingActivity.this, "내 위치 찾음", Toast.LENGTH_SHORT).show();                myLng = location.getLongitude();                myLat = location.getLatitude();                Log.d("LAT : ", String.valueOf(myLat));                Log.d("LNG : ", String.valueOf(myLng));                mapResults = new ArrayList<>();                minDist = 1000;                table.addValueEventListener(new ValueEventListener() {                    @Override                    public void onDataChange(DataSnapshot dataSnapshot) {                        for(DataSnapshot data: dataSnapshot.getChildren()){                            ToiletData result  = data.getValue(ToiletData.class);                            result.setToiletID(data.getKey());                            double tLat = Double.parseDouble(result.getToiletLat());                            double tLng = Double.parseDouble(result.getToiletLng());                            double distance = calcDistance(myLat, myLng, tLat, tLng);                                if(distance < 500){                                    flag = true;                                    if(minDist > distance){                                        minDist = distance;                                        minToilet.setToiletLat(String.valueOf(tLat));                                        minToilet.setToiletLng(String.valueOf(tLng));                                    }                                    mapResults.add(result);                                    if(Check_direct == false)                                        searchText.setText(String.valueOf(mapResults.size())+"개의 화장실을 찾았습니다");                            }                        }                        if(Check_direct == true && flag == true)                            getLocation(myLat, myLng, 1);                        if(Check_direct == false  && flag == true){                            Intent intent = new Intent(getApplicationContext(), Map2Activity.class);                            intent.putExtra("LAT", myLat);                            intent.putExtra("LNG", myLng);                            startActivity(intent);                            finish();                        }                    }                    @Override                    public void onCancelled(DatabaseError databaseError) {                    }                });            }        }        @Override        public void onStatusChanged(String provider, int status, Bundle extras) {        }        @Override        public void onProviderEnabled(String provider) {        }        @Override        public void onProviderDisabled(String provider) {        }    };    public void getLocation(double lat, double lng, int num){        if(num == 1){            myLocation = null;        }        else {            fastLocation = null;        }        List<Address> address;        try {            if (geocoder != null) {                address = geocoder.getFromLocation(lat, lng, 1);                if (address != null && address.size() > 0) {                    if(num == 1)                        myLocation = address.get(0).getAddressLine(0).toString();                    else                        fastLocation = address.get(0).getAddressLine(0).toString();                }            }        } catch (IOException e) {            Log.e("MainActivity", "주소를 찾지 못하였습니다.");            e.printStackTrace();        }        if(num == 1){            DIRECT_GOOGLEMAP();        }    }    public void DIRECT_GOOGLEMAP(){        getLocation(Double.parseDouble(minToilet.getToiletLat()), Double.parseDouble(minToilet.getToiletLng()), 0);        Uri uri = Uri.parse("http://maps.google.com/maps?f=d&saddr=" + myLocation + "&daddr=" + fastLocation + "&hl=ko");        Intent it = new Intent(Intent.ACTION_VIEW, uri);        it.setClassName("com.google.android.apps.maps","com.google.android.maps.MapsActivity");        startActivity(it);        finish();    }    public static double calcDistance(double lat1, double lon1, double lat2, double lon2){        double EARTH_R, Rad, radLat1, radLat2, radDist;        double distance, ret;        EARTH_R = 6371000.0;        Rad = Math.PI/180;        radLat1 = Rad * lat1;        radLat2 = Rad * lat2;        radDist = Rad * (lon1 - lon2);        distance = Math.sin(radLat1) * Math.sin(radLat2);        distance = distance + Math.cos(radLat1) * Math.cos(radLat2) * Math.cos(radDist);        ret = EARTH_R * Math.acos(distance);        return ret;    }}